<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام إدارة المسجلين</title>
    
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #6f8ef7; 
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #2c3e50;
        }
        body { font-family: 'Cairo', sans-serif; background-color: var(--light-color); }
        /* تم تعديل الـ content-wrapper ليملأ الشاشة */
        .content-wrapper { margin-right: 0; min-height: 100vh; }
        .content { padding: 2rem; }
        .topbar { height: 65px; background-color: white; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.15); }
        .topbar .navbar-nav .nav-item .nav-link { color: var(--secondary-color); }
        .card { border: none; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.15); margin-bottom: 1.5rem; transition: all 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card .card-body { padding: 1.5rem; }
        .card .card-header { background-color: transparent; border-bottom: 1px solid #e3e6f0; font-weight: 600; color: var(--dark-color); }
        .dashboard-card .card-body { padding: 1.25rem; }
        .dashboard-card .text-xs { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--secondary-color); }
        .dashboard-card .text-primary { color: var(--primary-color) !important; }
        .dashboard-card .text-success { color: var(--success-color) !important; }
        .dashboard-card .text-info { color: var(--info-color) !important; }
        .dashboard-card .text-warning { color: var(--warning-color) !important; }
        .table { color: var(--secondary-color); }
        .table thead th { border-bottom: 2px solid #e3e6f0; font-weight: 600; }
        #login-screen { background: linear-gradient(135deg, var(--primary-color) 0%, #5a7fdb 100%); }
        #login-screen .card { border: none; border-radius: 1rem; }
        #login-screen .card-body { padding: 3rem; }
        .login-logo { display: block; margin: 0 auto 2rem auto; max-width: 180px; }
        .modal-content { border: none; border-radius: 0.5rem; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }
        .modal-header { border-bottom: 1px solid #e3e6f0; }
        .notification-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 1050; }
    </style>
</head>
<body>

    <!-- شاشة تسجيل الدخول -->
    <div id="login-screen" class="container-fluid d-flex justify-content-center align-items-center vh-100">
        <div class="card shadow-lg" style="width: 100%; max-width: 400px;">
            <div class="card-body p-4">
                <img src="logo.png" alt="Logo" class="login-logo">
                <h3 class="card-title text-center mb-4">تسجيل الدخول</h3>
                <form id="login-form">
                    <div class="mb-3"><label for="login-email" class="form-label">البريد الإلكتروني</label><input type="email" class="form-control" id="login-email" required></div>
                    <div class="mb-3"><label for="login-password" class="form-label">كلمة المرور</label><input type="password" class="form-control" id="login-password" required></div>
                    <button type="submit" class="btn btn-primary w-100">دخول</button>
                </form>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="main-app" class="d-none">
        <!-- المحتوى الرئيسي -->
        <div class="content-wrapper">
            <!-- الشريط العلوي -->
            <nav class="navbar navbar-expand topbar">
                <div class="container-fluid">
                    <a class="navbar-brand text-gray-800" href="#">
                        <img src="logo.png" alt="Logo" style="height: 30px; margin-left: 10px;">
                        نظام إدارة المسجلين
                    </a>
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow animated--grow-in">
                                <li><a class="dropdown-item" href="#" id="logout-btn"><i class="bi bi-box-arrow-left"></i> تسجيل الخروج</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- المحتوى -->
            <div class="content">
                <!-- عرض لوحة التحكم -->
                <div id="dashboard-view">
                    <h1 class="h3 mb-4 text-gray-800">لوحة التحكم</h1>
                    
                    <!-- بطاقات الإحصائيات -->
                    <div class="row">
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card dashboard-card border-left-primary shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-primary text-uppercase mb-1">إجمالي المسجلين</div><div class="h5 mb-0 font-weight-bold text-gray-800" id="total-trainees">0</div></div><div class="col-auto"><i class="bi bi-people-fill fa-2x text-gray-300"></i></div></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card dashboard-card border-left-success shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-success text-uppercase mb-1">مهام منجزة</div><div class="h5 mb-0 font-weight-bold text-gray-800" id="completed-tasks">0</div></div><div class="col-auto"><i class="bi bi-clipboard-check-fill fa-2x text-gray-300"></i></div></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card dashboard-card border-left-info shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-info text-uppercase mb-1">مهام معلقة</div><div class="h5 mb-0 font-weight-bold text-gray-800" id="pending-tasks">0</div></div><div class="col-auto"><i class="bi bi-hourglass-split fa-2x text-gray-300"></i></div></div></div></div></div>
                        <div class="col-xl-3 col-md-6 mb-4"><div class="card dashboard-card border-left-warning shadow h-100 py-2"><div class="card-body"><div class="row no-gutters align-items-center"><div class="col mr-2"><div class="text-xs font-weight-bold text-warning text-uppercase mb-1">مهام قادمة</div><div class="h5 mb-0 font-weight-bold text-gray-800" id="upcoming-tasks">0</div></div><div class="col-auto"><i class="bi bi-calendar-event-fill fa-2x text-gray-300"></i></div></div></div></div></div>
                    </div>

                    <!-- نموذج إضافة مسجل جديد -->
                    <div class="card shadow mb-4">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">إضافة مسجل جديد</h6>
                        </div>
                        <div class="card-body">
                            <form id="traineeForm" class="row g-3">
                                <div class="col-md-6"><label for="name" class="form-label">الاسم الكامل</label><input type="text" class="form-control" id="name" required></div>
                                <div class="col-md-6"><label for="phone" class="form-label">رقم الجوال</label><input type="tel" class="form-control" id="phone" required></div>
                                <div class="col-md-6"><label for="courseName" class="form-label">الدورة التدريبية</label><input type="text" class="form-control" id="courseName" required></div>
                                <div class="col-md-3"><label for="registrationDate" class="form-label">تاريخ التسجيل</label><input type="date" class="form-control" id="registrationDate" required></div>
                                <div class="col-md-3"><label for="taskDate" class="form-label">تاريخ إنجاز الملاحظة</label><input type="date" class="form-control" id="taskDate"></div>
                                <div class="col-12"><label for="notes" class="form-label">ملاحظات التسجيل</label><textarea class="form-control" id="notes" rows="2"></textarea></div>
                                <div class="col-12"><button type="submit" class="btn btn-primary"><i class="bi bi-plus-circle"></i> إضافة مسجل</button></div>
                            </form>
                        </div>
                    </div>

                    <!-- جدول المسجلين -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">قائمة المسجلين</h6>
                            <div><input type="text" class="form-control d-inline-block w-auto ms-2" id="search-input" placeholder="بحث..."><button class="btn btn-success" id="export-btn"><i class="bi bi-download"></i> تصدير</button></div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>الاسم</th><th>الجوال</th><th>الدورة</th><th>تسجيل</th><th>الملاحظة</th><th>الحالة</th><th>إجراءات</th></tr></thead><tbody id="traineesList"></tbody></table></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تعديل -->
    <div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">تعديل بيانات المسجل</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="editForm" class="row g-3"><div class="col-md-6"><label class="form-label">الاسم</label><input type="text" class="form-control" id="edit-name" required></div><div class="col-md-6"><label class="form-label">الجوال</label><input type="tel" class="form-control" id="edit-phone" required></div><div class="col-md-6"><label class="form-label">الدورة</label><input type="text" class="form-control" id="edit-courseName" required></div><div class="col-md-3"><label class="form-label">تسجيل</label><input type="date" class="form-control" id="edit-registrationDate" required></div><div class="col-md-3"><label class="form-label">تاريخ الملاحظة</label><input type="date" class="form-control" id="edit-taskDate"></div><div class="col-12"><label class="form-label">ملاحظات</label><textarea class="form-control" id="edit-notes" rows="3"></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-success" id="save-edit-btn">حفظ</button></div></div></div></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
    let toggleComplete, openEditModal, deleteTrainee;

    document.addEventListener('DOMContentLoaded', () => {
        
        // *** هام جداً: الصق بيانات firebaseConfig هنا بالكامل ***
        const firebaseConfig = {
          apiKey: "AIzaSyBao29SN4otllJSiczNwLDyUvvNmj-vpz8",
          authDomain: "future-353e4.firebaseapp.com",
          projectId: "future-353e4",
          storageBucket: "future-353e4.firebasestorage.app",
          messagingSenderId: "889060872247",
          appId: "1:889060872247:web:abbb9ed520fd60adfbafb2",
          measurementId: "G-GJLG370D17"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const traineesRef = database.ref('trainees');

        const loginScreen = document.getElementById('login-screen');
        const mainApp = document.getElementById('main-app');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        const saveEditBtn = document.getElementById('save-edit-btn');
        let currentEditId = null;
        let allTrainees = [];

        function showNotification(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show notification-container`;
            alertDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        function showScreen(screenName) {
            loginScreen.classList.toggle('d-none', screenName !== 'login');
            mainApp.classList.toggle('d-none', screenName !== 'main');
        }

        auth.onAuthStateChanged(user => {
            if (user) { showScreen('main'); displayTrainees(); }
            else { showScreen('login'); }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            auth.signInWithEmailAndPassword(email, password).catch(error => showNotification('فشل تسجيل الدخول: ' + error.message, 'danger'));
        });

        logoutBtn.addEventListener('click', () => auth.signOut().then(() => showNotification('تم تسجيل الخروج.')));

        deleteTrainee = function(id) { if (confirm('هل أنت متأكد؟')) traineesRef.child(id).remove().catch(error => showNotification(error.message, 'danger')); };
        toggleComplete = function(id, isChecked) { traineesRef.child(id).update({ isCompleted: isChecked }).catch(error => showNotification(error.message, 'danger')); };
        openEditModal = function(traineeString) {
            const trainee = JSON.parse(traineeString);
            currentEditId = trainee.id;
            document.getElementById('edit-name').value = trainee.name;
            document.getElementById('edit-phone').value = trainee.phone;
            document.getElementById('edit-courseName').value = trainee.courseName;
            document.getElementById('edit-registrationDate').value = trainee.registrationDate;
            document.getElementById('edit-taskDate').value = trainee.taskDate || '';
            document.getElementById('edit-notes').value = trainee.notes || '';
            editModal.show();
        };

        function displayTrainees() {
            traineesRef.orderByChild('timestamp').on('value', (snapshot) => {
                allTrainees = []; traineesList.innerHTML = '';
                let stats = { total: 0, completed: 0, pending: 0, upcoming: 0 };
                snapshot.forEach(childSnapshot => {
                    const trainee = { id: childSnapshot.key, ...childSnapshot.val() };
                    allTrainees.push(trainee);
                    stats.total++; if (trainee.isCompleted) stats.completed++; else stats.pending++;
                    if (isDateUpcoming(trainee.taskDate)) stats.upcoming++;
                    const row = document.createElement('tr');
                    if (trainee.isCompleted) row.classList.add('task-completed');
                    else if (isDateUpcoming(trainee.taskDate)) row.classList.add('task-upcoming');
                    row.innerHTML = `<td>${trainee.name}</td><td>${trainee.phone}</td><td>${trainee.courseName}</td><td>${trainee.registrationDate}</td><td>${trainee.taskDate || '---'}</td><td>${trainee.notes || 'لا توجد'}</td><td><input class="form-check-input" type="checkbox" ${trainee.isCompleted ? 'checked' : ''} onchange="toggleComplete('${trainee.id}', this.checked)"></td><td><button class="btn btn-sm btn-warning" onclick="openEditModal(\`${JSON.stringify(trainee).replace(/`/g, '\\`')}\`)"><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-danger" onclick="deleteTrainee('${trainee.id}')"><i class="bi bi-trash"></i></button></td>`;
                    traineesList.appendChild(row);
                });
                updateDashboard(stats);
            });
        }
        
        function updateDashboard(stats) {
            document.getElementById('total-trainees').textContent = stats.total;
            document.getElementById('completed-tasks').textContent = stats.completed;
            document.getElementById('pending-tasks').textContent = stats.pending;
            document.getElementById('upcoming-tasks').textContent = stats.upcoming;
        }

        function isDateUpcoming(taskDateString) { if (!taskDateString) return false; const taskDate = new Date(taskDateString); const today = new Date(); today.setHours(0, 0, 0, 0); const twoDaysFromNow = new Date(today); twoDaysFromNow.setDate(today.getDate() + 2); return taskDate >= today && taskDate <= twoDaysFromNow; }
        
        document.getElementById('traineeForm').addEventListener('submit', (e) => { e.preventDefault(); const newTrainee = { name: document.getElementById('name').value, phone: document.getElementById('phone').value, courseName: document.getElementById('courseName').value, registrationDate: document.getElementById('registrationDate').value, taskDate: document.getElementById('taskDate').value, notes: document.getElementById('notes').value, isCompleted: false, timestamp: Date.now() }; traineesRef.push(newTrainee).then(() => { showNotification('تمت الإضافة!'); document.getElementById('traineeForm').reset(); }).catch(error => showNotification(error.message, 'danger')); });
        saveEditBtn.addEventListener('click', () => { const updatedTrainee = { name: document.getElementById('edit-name').value, phone: document.getElementById('edit-phone').value, courseName: document.getElementById('edit-courseName').value, registrationDate: document.getElementById('edit-registrationDate').value, taskDate: document.getElementById('edit-taskDate').value, notes: document.getElementById('edit-notes').value, }; traineesRef.child(currentEditId).update(updatedTrainee).then(() => { showNotification('تم التعديل!'); editModal.hide(); }).catch(error => showNotification(error.message, 'danger')); });
        document.getElementById('search-input').addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); const rows = traineesList.getElementsByTagName('tr'); Array.from(rows).forEach(row => { const name = row.cells[0].textContent.toLowerCase(); const phone = row.cells[1].textContent.toLowerCase(); row.style.display = name.includes(searchTerm) || phone.includes(searchTerm) ? '' : 'none'; }); });
        document.getElementById('export-btn').addEventListener('click', () => { let csv = '\ufeffالاسم,رقم الجوال,الدورة,تاريخ التسجيل,تاريخ الملاحظة,الملاحظات,الحالة\n'; allTrainees.forEach(t => { csv += `"${t.name}","${t.phone}","${t.courseName}","${t.registrationDate}","${t.taskDate || ''}","${t.notes || ''}","${t.isCompleted ? 'منجزة' : 'معلقة'}"\n`; }); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `trainees_${new Date().toISOString().slice(0, 10)}.csv`; link.click(); showNotification('تم التصدير!'); });
    });
    </script>
</body>
</html>
